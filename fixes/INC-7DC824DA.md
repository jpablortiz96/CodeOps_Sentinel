# Incident Fix: INC-7DC824DA

## Diagnosis
- **Root Cause**: N+1 ORM query pattern in the payment handler: each order triggers a separate DB call to fetch line items. With 847 queries/request at peak load, this saturates CPU and exhausts the connection pool.
- **Severity**: IncidentSeverity.CRITICAL
- **Affected Services**: payment-service, postgresql, api-gateway
- **Detected At**: 2026-02-16 12:37:48 UTC

## Recommended Fix
Add explicit listener cleanup on WebSocket disconnect to prevent heap growth

## Code Changes
```python
# Original code (problematic)
socket.on('connect', () => {
  eventBus.on('order:update', (data) => socket.emit('update', data));
  eventBus.on('alert', (data) => socket.emit('alert', data));
});

# Fixed code
socket.on('connect', () => {
  // Fix: named refs so we can remove them precisely on disconnect
  const onOrderUpdate = (data) => socket.emit('update', data);
  const onAlert = (data) => socket.emit('alert', data);

  eventBus.on('order:update', onOrderUpdate);
  eventBus.on('alert', onAlert);

  socket.on('disconnect', () => {
    eventBus.removeListener('order:update', onOrderUpdate);
    eventBus.removeListener('alert', onAlert);
  });
});
```

## Auto-Remediation Applied
- **Action**: Stopped chaos experiment via API
- **Result**: Service recovered
- **Resolution Time**: N/A

## Generated by
CodeOps Sentinel â€” Fixer Agent v2.0  
Powered by Azure OpenAI GPT-4o + Microsoft Agent Framework
