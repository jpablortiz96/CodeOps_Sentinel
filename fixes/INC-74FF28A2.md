# Incident Fix: INC-74FF28A2

## Diagnosis
- **Root Cause**: Missing composite index on transactions(user_id, created_at). PostgreSQL planner performs full sequential scan on 12.4M rows for every user history query. Traffic spike 3× normal multiplied the impact.
- **Severity**: IncidentSeverity.HIGH
- **Affected Services**: postgresql, user-service, api-gateway
- **Detected At**: 2026-02-21 11:50:06 UTC

## Recommended Fix
Add explicit listener cleanup on WebSocket disconnect to prevent heap growth

## Code Changes
```python
# Original code (problematic)
socket.on('connect', () => {
  eventBus.on('order:update', (data) => socket.emit('update', data));
  eventBus.on('alert', (data) => socket.emit('alert', data));
});

# Fixed code
socket.on('connect', () => {
  // Fix: named refs so we can remove them precisely on disconnect
  const onOrderUpdate = (data) => socket.emit('update', data);
  const onAlert = (data) => socket.emit('alert', data);

  eventBus.on('order:update', onOrderUpdate);
  eventBus.on('alert', onAlert);

  socket.on('disconnect', () => {
    eventBus.removeListener('order:update', onOrderUpdate);
    eventBus.removeListener('alert', onAlert);
  });
});
```

## Auto-Remediation Applied
- **Action**: Stopped chaos experiment via API
- **Result**: Service recovered
- **Resolution Time**: N/A

## Generated by
CodeOps Sentinel — Fixer Agent v2.0  
Powered by Azure OpenAI GPT-4o + Microsoft Agent Framework
