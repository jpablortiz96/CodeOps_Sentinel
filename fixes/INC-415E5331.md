# Incident Fix: INC-415E5331

## Diagnosis
- **Root Cause**: Missing composite index on transactions(user_id, created_at). PostgreSQL planner performs full sequential scan on 12.4M rows for every user history query. Traffic spike 3× normal multiplied the impact.
- **Severity**: IncidentSeverity.HIGH
- **Affected Services**: postgresql, user-service, api-gateway
- **Detected At**: 2026-02-20 11:00:06 UTC

## Recommended Fix
Replace N+1 item queries with eager loading JOIN + Redis cache

## Code Changes
```python
# Original code (problematic)
const orders = await orderRepo.find({ userId });
for (const order of orders) {
  order.items = await itemRepo.find({ orderId: order.id });
}

# Fixed code
// Fix: single JOIN query + Redis cache (TTL=300s)
const cacheKey = `orders:${userId}`;
const cached = await redis.get(cacheKey);
if (cached) return JSON.parse(cached);

const orders = await orderRepo.find({
  where: { userId },
  relations: ['items'],  // 1 JOIN query instead of N queries
});
await redis.setex(cacheKey, 300, JSON.stringify(orders));
return orders;
```

## Auto-Remediation Applied
- **Action**: Stopped chaos experiment via API
- **Result**: Service recovered
- **Resolution Time**: N/A

## Generated by
CodeOps Sentinel — Fixer Agent v2.0  
Powered by Azure OpenAI GPT-4o + Microsoft Agent Framework
